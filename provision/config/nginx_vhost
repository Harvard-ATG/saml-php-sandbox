server {
	listen 80;
	server_name localhost saml.localhost;
	
	root /var/www/src/saml/app;
	index index.php index.html;
	
	# Important for VirtualBox
	sendfile off;
	
	location / {
		try_files $uri $uri/ =404;
	}
	
	location ~* \.php {
		include fastcgi_params;
		
		fastcgi_pass unix:/var/run/php5-fpm.sock;
		
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_cache off;
		fastcgi_index index.php;
	}
}

server {
	listen 80;
	server_name idp.saml.localhost;
	
	root /var/www/src/saml-idp/app;
	index index.php index.html;
	
	
	sendfile off; # for VirtualBox
	
	location /app {
		alias /var/www/src/saml-idp/app;
		include fastcgi_params;
		fastcgi_pass unix:/var/run/php5-fpm.sock;
	}

	location ~ ^/simplesaml {
		alias /var/www/src/saml-idp/simplesamlphp/www;
		location ~ ^/simplesaml(/resources/.*) {
			try_files $1 =404;
		}
		location ~ ^/simplesaml/.+\.php$ {
			include fastcgi_params;
	
			# Test cases for splitting the path info (tested via regex101.com):
			# 1) /simplesaml/index.php
			# 2) /simplesaml/module.php
			# 3) /simplesaml/saml2/idp/metadata.php
			# 4) /simplesaml/module.php/core/frontpage_welcome.php
			fastcgi_split_path_info ^/simplesaml(/.+?\.php)(/.+\.php)?;
	
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;

			fastcgi_pass unix:/var/run/php5-fpm.sock;
		}
	}
}

server {
	listen 80;
	server_name idproxy.saml.localhost;
	
	root /var/www/src/saml-idproxy/;
	index index.php index.html;
	
	# Important for VirtualBox
	sendfile off;

	location /app {
		alias /var/www/src/saml-idp/app;
		include fastcgi_params;
		fastcgi_pass unix:/var/run/php5-fpm.sock;
	}

	location ~ ^/simplesaml {
		alias /var/www/src/saml-idp/simplesamlphp/www;
		location ~ ^/simplesaml(/resources/.*) {
			try_files $1 =404;
		}
		location ~ ^/simplesaml/.+\.php$ {
			include fastcgi_params;
	
			# Test cases for splitting the path info (tested via regex101.com):
			# 1) /simplesaml/index.php
			# 2) /simplesaml/module.php
			# 3) /simplesaml/saml2/idp/metadata.php
			# 4) /simplesaml/module.php/core/frontpage_welcome.php
			fastcgi_split_path_info ^/simplesaml(/.+?\.php)(/.+\.php)?;
	
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;

			fastcgi_pass unix:/var/run/php5-fpm.sock;
		}
	}
}

server {
	listen 80;
	server_name sp.saml.localhost;
	
	root /var/www/src/saml-sp/;
	index index.php index.html;
	
	# Important for VirtualBox
	sendfile off;
	
	location /app {
		alias /var/www/src/saml-idp/app;
		include fastcgi_params;
		fastcgi_pass unix:/var/run/php5-fpm.sock;
	}

	location ~ ^/simplesaml {
		alias /var/www/src/saml-idp/simplesamlphp/www;
		location ~ ^/simplesaml(/resources/.*) {
			try_files $1 =404;
		}
		location ~ ^/simplesaml/.+\.php$ {
			include fastcgi_params;
	
			# Test cases for splitting the path info (tested via regex101.com):
			# 1) /simplesaml/index.php
			# 2) /simplesaml/module.php
			# 3) /simplesaml/saml2/idp/metadata.php
			# 4) /simplesaml/module.php/core/frontpage_welcome.php
			fastcgi_split_path_info ^/simplesaml(/.+?\.php)(/.+\.php)?;
	
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;

			fastcgi_pass unix:/var/run/php5-fpm.sock;
		}
	}
}
